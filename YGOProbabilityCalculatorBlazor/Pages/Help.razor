@page "/help"
@using YGOProbabilityCalculatorBlazor.Services.Interface
@inject NavigationManager NavigationManager
@inject ISessionService _sessionService
@inject IFileService _fileService
@inject IPendingSessionService _pendingSessionService

<div class="container mt-4">
    <section class="mb-4">
        <h2>Yu-Gi-Oh! Advanced Probability Calculator</h2>
        <p>This is a deck-building tool that calculates the <strong>exact probability</strong> of opening playable hands in Yu-Gi-Oh!, 
            even for complex 2- and 3-card combo setups.</p>
    </section>

    <section class="mb-4">
        <h2>How It Works</h2>
        <ol>
            <li><strong>Create Categories:</strong> Tag card roles like "Starter", "Extender", "X", "CombosWithX", etc.</li>
            <li><strong>Assign Categories to Cards:</strong> Each card can belong to multiple categories.</li>
            <li><strong>Define Combos:</strong> Each combo is a combination of required categories (e.g., "Lubellion + Normal Summon").</li>
            <li><strong>Set Constraints:</strong> Define per-category min/max requirements.</li>
            <li><strong>Calculate:</strong> Get exact probabilities for opening <strong>any</strong> of the defined combos in your deck.</li>
        </ol>
    </section>

    <section class="mb-4">
        <h2>Example: Fiendsmith Bystial Deck</h2>
        <p>This deck can access its main combo by summoning any LIGHT Fiend monster to fulfill the requirements for "Fiendsmith Requiem". 
            That can be accomplished by opening a one-card starter or by assembling a 2-card combo that can summon "Moon of the Closed Heaven" 
            using any two Effect Monsters.</p>
        <p>The only way to summon additional effect monsters that are not LIGHT Fiends in this deck is by either using Bystials or 
            Normal Summoning a hand trap. Bystials require a LIGHT or DARK monster in either GY to banish, and there are two ways this 
            can be achieved on the first turn.</p>
        <p>If the Bystial was added by sending "The Bystial Lubellion" to the GY, it can always be summoned, so it combos with every 
            normal summonable hand trap. However, if the Bystial was drawn normally, the normal summonable hand trap needs to be a LIGHT 
            or DARK attribute and fulfill the requirements to summon "Salamangreat Almiraj", so it can be sent to the GY and used for 
            the summon of the Bystial.</p>

        <h3>Category Definitions</h3>
        <ul>
            <li><strong>1 Card Starter:</strong> Any single card that independently initiates a Fiendsmith combo.</li>
            <li><strong>Bystial:</strong> Any "Bystial" monster that can summon itself.</li>
            <li><strong>Lubellion:</strong> Specifically "The Bystial Lubellion".</li>
            <li><strong>Normal Summon:</strong> Any monster that can be Normal Summoned (e.g., Ash Blossom & Joyous Spring).</li>
            <li><strong>L/D Normal Summon:</strong> Any LIGHT or DARK monster that can be Normal Summoned and sent to the GY by summoning "Salamangreat Almiraj" (e.g., Effect Veiler).</li>
        </ul>

        <h3>Combo Definitions</h3>
        <ul>
            <li><strong>1-Card Combo:</strong> Requires <em>any</em> card with the "1 Card Starter" tag.</li>
            <li><strong>Moon Combo 1:</strong> Requires <em>both</em> the "Lubellion" tag <em>and</em> the "Normal Summon" tag in the opening hand.</li>
            <li><strong>Moon Combo 2:</strong> Requires <em>both</em> the "Bystial" tag <em>and</em> the "L/D Normal Summon" tag in the opening hand.</li>
        </ul>

        <p>After tagging all cards appropriately, this configuration will calculate the exact probability of opening a Fiendsmith play in the given deck list.</p>

        <div class="mt-3">
            <button class="btn btn-primary" @onclick="LoadExampleSession">Try It with Example Data</button>
            @if (!string.IsNullOrEmpty(errorMessage)) {
                <div class="alert alert-danger mt-2">
                    @errorMessage
                </div>
            }
        </div>
    </section>

    <section class="mb-4">
        <h2>Optimization Tips</h2>
        <p>For further optimization, you could define categories like "Handtrap" or "Brick", then require all of your combos 
            to open at least one "Handtrap"-tagged card while opening zero "Brick"-tagged cards.</p>
        <p>This can help determine optimal deck sizes and engine ratios.</p>
    </section>

    <section class="mb-4">
        <h2>Credits</h2>
        <p>Created by <a href="https://github.com/SeyTi01" target="_blank" rel="noopener noreferrer">SeyTi01</a></p>
    </section>
</div>

@code {
    private string? errorMessage;

    private async Task LoadExampleSession() {
        try {
            var fileContent = await _fileService.ReadAllTextAsync("sample-data/example_session_state.json");
            if (string.IsNullOrEmpty(fileContent)) {
                errorMessage = "The example session file is empty";
                StateHasChanged();
                return;
            }

            var session = await _sessionService.LoadSessionAsync(fileContent);
            _pendingSessionService.PendingSession = session;
            NavigationManager.NavigateTo("/", forceLoad: false);
        }
        catch (Exception ex) {
            errorMessage = $"Failed to load example session: {ex.Message}";
            StateHasChanged();
        }
    }
}
